name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-win:
    name: Build Windows
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Ensure npm cache dir exists (Windows)
        if: runner.os == 'Windows'
        run: |
          powershell -Command "New-Item -ItemType Directory -Force -Path C:\\npm\\cache | Out-Null"

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: C:\\npm\\cache
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache electron build cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.LOCALAPPDATA }}\\electron\\Cache
          key: ${{ runner.os }}-electron-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: Ensure electron cache dir exists (Windows)
        if: runner.os == 'Windows'
        run: |
          powershell -Command "New-Item -ItemType Directory -Force -Path $env:LOCALAPPDATA\\electron\\Cache | Out-Null"

      - name: Ensure npm cache dir exists (mac/linux)
        if: runner.os != 'Windows'
        run: mkdir -p ~/.npm

      - name: Cache npm (mac/linux)
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        run: |
          cd $env:GITHUB_WORKSPACE
          if (Test-Path package-lock.json) {
            npm ci
          } else {
            npm install
          }
        shell: powershell

      - name: Build renderer
        run: |
          cd $env:GITHUB_WORKSPACE
          npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build installers (signed if valid `CSC_LINK` present)
        run: |
          $ErrorActionPreference = 'Stop'          

          $raw = '${{ secrets.CSC_LINK }}'
          $pwd = '${{ secrets.CSC_KEY_PASSWORD }}'
          $Env:CSC_LINK = $null

          if (-not [string]::IsNullOrEmpty($raw)) {
            Write-Host "Secrets provided. Processing certificate..."
            try {
              if ($raw -like 'base64:*') {
                $b64 = $raw -replace '^base64:', ''
                $out = Join-Path $env:TEMP 'ci-sign-cert.p12'
                [IO.File]::WriteAllBytes($out, [Convert]::FromBase64String($b64))
                $Env:CSC_LINK = $out
              } elseif ($raw -match '^https?://') {
                $out = Join-Path $env:TEMP 'ci-sign-cert.p12'
                Invoke-WebRequest -Uri $raw -OutFile $out -UseBasicParsing
                $Env:CSC_LINK = $out
              } elseif (Test-Path $raw) {
                $Env:CSC_LINK = $raw
              }
            } catch {
              Write-Warning "Certificate processing failed: $_"
              $Env:CSC_LINK = $null
            }
          } else {
             Write-Host "No CSC_LINK secret provided. Skipping signing setup."
          }
            
          if (-not [string]::IsNullOrEmpty($Env:CSC_LINK)) {
             Write-Host "Certificate setup complete: $Env:CSC_LINK"
             $Env:CSC_KEY_PASSWORD = $pwd
          } else {
             Write-Host "Building without signing."
          }
          
          npx electron-builder --config electron-builder.json5 -c.directories.output=release --win nsis zip --${{ matrix.arch }} --publish never
          
          if ($LASTEXITCODE -ne 0) { 
            Write-Error "Build failed with code: $LASTEXITCODE"
            exit 1 
          }
        shell: powershell

      - name: Show release directory contents (Windows)
        run: |
          cd $env:GITHUB_WORKSPACE
          Write-Host "Listing release directory:"
          Get-ChildItem -Recurse -Path ./release | Format-List
        shell: powershell

      - name: Upload Windows artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.exe
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  build-mac:
    name: Build macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Ensure electron cache dir exists (mac/linux)
        if: runner.os != 'Windows'
        run: mkdir -p ~/.cache/electron

      - name: Cache electron build cache (mac/linux)
        if: runner.os != 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
          key: ${{ runner.os }}-electron-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: Build renderer
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build mac artifacts (signed if valid `CSC_LINK` present)
        run: |
          raw='${{ secrets.CSC_LINK }}'
          pwd='${{ secrets.CSC_KEY_PASSWORD }}'
          export APPLE_ID='${{ secrets.APPLE_ID }}'
          export APPLE_PASSWORD='${{ secrets.APPLE_PASSWORD }}'

          if [ -n "$raw" ]; then
            case "$raw" in
              base64:*)
                b64=${raw#base64:}
                out=/tmp/ci-sign-cert.p12
                printf '%s' "$b64" | base64 -d > "$out"
                echo "Wrote base64 CSC_LINK to $out"
                export CSC_LINK="$out"
                ;;
              http://*|https://*)
                out=/tmp/ci-sign-cert.p12
                curl -fsSL "$raw" -o "$out" || { echo 'Failed to download CSC_LINK'; unset CSC_LINK; }
                echo "Downloaded CSC_LINK to $out"
                export CSC_LINK="$out"
                ;;
              *)
                if [ -f "$raw" ]; then
                  export CSC_LINK="$raw"
                  echo "CSC_LINK points to existing file: $raw"
                else
                  echo "CSC_LINK provided but not recognized as base64/url/file: will skip signing"
                  unset CSC_LINK
                fi
                ;;
            esac
          else
            echo "No CSC_LINK secret provided"
          fi

          if [ -n "$CSC_LINK" ] && [ -f "$CSC_LINK" ]; then
            export CSC_KEY_PASSWORD="$pwd"
            echo "Valid signing material found — building signed mac artifact"
            npx electron-builder --mac --${{ matrix.arch }} --publish never
          else
            echo "No valid signing material — building unsigned mac artifact"
            npx electron-builder --mac --${{ matrix.arch }} --publish never
          fi

      - name: Upload macOS artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/**/*.dmg
            release/**/*.dmg.blockmap
            release/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build renderer
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build linux artifacts
        run: npx electron-builder --linux --${{ matrix.arch }} --publish never

      - name: Upload Linux artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/**/*.AppImage
            release/**/*.deb
            release/**/*.AppImage.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
